import streamlit as st
import fitz  # PyMuPDF
from fpdf import FPDF

# ××—×œ×§×ª PDF ×¢× ×ª××™×›×” ×‘×¢×‘×¨×™×ª
class ReportPDF(FPDF):
    def __init__(self):
        super().__init__()
        self.add_page()
        self.add_font("Noto", "", "NotoSansHebrew-Regular.ttf", uni=True)
        self.set_font("Noto", size=12)

    def add_result_table(self, filename, results, score):
        self.set_font("Noto", size=12)
        self.cell(0, 10, txt=f"×§×•×‘×¥: {filename}", ln=True)
        self.ln(5)

        for key, value in results.items():
            result_text = 'âœ“' if value else 'âœ—'
            self.cell(60, 10, txt=key[::-1], border=1)  # ×”×™×¤×•×š ×ª×•×•×™× ×œ×”×¦×’×” RTL
            self.cell(20, 10, txt=result_text, border=1)
            self.ln()

        self.ln(5)
        self.set_font("Noto", "B", 12)
        self.cell(0, 10, txt=f"×¦×™×•×Ÿ ×›×•×œ×œ: {score}%", ln=True)

# ×¤×•× ×§×¦×™×” ×œ×§×¨×™××ª ×˜×§×¡×˜ ××”-PDF
def extract_text_from_pdf(file):
    text = ""
    doc = fitz.open(stream=file.read(), filetype="pdf")
    for page in doc:
        text += page.get_text()
    return text

# ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×” ××•×œ ×“×¨×™×©×•×ª ISO ×‘×¡×™×¡×™×•×ª
def check_requirements(text):
    text = text.lower()
    results = {
        "×›×•×ª×¨×ª": "title" in text,
        "××¡×¤×¨ ×©×¨×˜×•×˜": "drawing number" in text,
        "×—×ª×™××”": "signature" in text,
        "×ª××¨×™×š": "date" in text,
        "××”×“×•×¨×”": "revision" in text,
        "×›××•×ª ×™×—×™×“×•×ª": "quantity" in text,
        "×©× ×”×›×•×ª×‘": "author" in text,
        "×˜×‘×œ×ª ××™×“×•×ª": "dimension table" in text
    }
    return results

# ×××©×§ ××©×ª××©
st.title("ğŸ“ ISO ×‘×•×“×§ ×©×¨×˜×•×˜×™× ×œ×¤×™ ×ª×§×Ÿ")
st.markdown("×›×“×™ ×œ×•×•×“× ×©×›×œ ×”×¨×›×™×‘×™× ×”× ×“×¨×©×™× ×§×™×™××™× ×‘×©×¨×˜×•×˜ (×œ×¤×™ ISO), ×”×¢×œ×” ×§×‘×¦×™ PDF")

uploaded_files = st.file_uploader("×‘×—×¨ ×§×‘×¦×™ PDF", type="pdf", accept_multiple_files=True)

if uploaded_files:
    pdf = ReportPDF()

    for file in uploaded_files:
        text = extract_text_from_pdf(file)
        results = check_requirements(text)
        score = round(100 * sum(results.values()) / len(results))

        pdf.add_result_table(file.name, results, score)

        st.subheader(file.name)
        st.table({k: 'âœ“' if v else 'âœ—' for k, v in results.items()})
        st.markdown(f"**×¦×™×•×Ÿ ×›×•×œ×œ:** {score}%")

    # ×”×¤×§×ª ×”×“×•×—
    report_file = "iso_check_report.pdf"
    pdf.output(report_file)

    with open(report_file, "rb") as f:
        st.download_button("ğŸ“¥ ×”×•×¨×“ ×“×•×— PDF ××¡×›×", f, file_name=report_file)
